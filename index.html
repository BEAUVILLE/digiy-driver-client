<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>DIGIY DRIVER ‚Äî Commander une course</title>
  <meta name="theme-color" content="#0a0a0a" />
  <meta name="description" content="Commandez votre VTC au S√©n√©gal - Prix justes, chauffeurs pros, 0% commission" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#0a0a0a;
      --card:#151515;
      --card2:#1f1f1f;
      --line:#2a2a2a;
      --gold:#FFD700;
      --gold2:#C7A008;
      --text:#fff;
      --muted:#a3a3a3;
      --green:#00C853;
      --red:#FF5252;
      --blue:#2196F3;
      --orange:#FF9800;
      --radius:18px;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    body{background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
    a{color:var(--gold);text-decoration:none}
    .app{min-height:100vh;display:flex;flex-direction:column}

    /* Header */
    .header{
      background:linear-gradient(135deg,#141414,#1f1f1f);
      border-bottom:2px solid var(--gold);
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;
      position:sticky;top:0;z-index:999;
    }
    .header-left{display:flex;gap:10px;align-items:center}
    .logo{font-size:26px}
    .title{font-size:16px;font-weight:900;color:var(--gold);letter-spacing:.02em}
    .sub{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:8px;margin-top:2px}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:3px 9px;border-radius:999px;font-size:10px;font-weight:800;
      border:1px solid var(--line);background:rgba(255,255,255,.04);
    }
    .dot{width:7px;height:7px;border-radius:50%}
    .dot.off{background:var(--red)}
    .dot.on{background:var(--green)}
    .header-right{display:flex;gap:10px;align-items:center}
    .btn-icon{
      width:42px;height:42px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);color:#fff;font-size:18px;cursor:pointer;
    }
    .btn-sos{
      width:46px;height:46px;border-radius:50%;
      border:none;background:var(--red);color:#fff;font-weight:1000;font-size:12px;
      cursor:pointer;
      box-shadow:0 0 0 0 rgba(255,82,82,.55);
      animation:sosPulse 2s infinite;
    }
    @keyframes sosPulse{
      0%,100%{box-shadow:0 0 0 0 rgba(255,82,82,.55)}
      50%{box-shadow:0 0 0 20px rgba(255,82,82,0)}
    }

    /* Map */
    .map-wrap{flex:1;position:relative;min-height:320px}
    #map{position:absolute;inset:0}
    .map-actions{
      position:absolute;right:16px;bottom:16px;z-index:500;
      display:flex;flex-direction:column;gap:10px;
    }
    .fab{
      width:52px;height:52px;border-radius:50%;
      border:none;cursor:pointer;
      background:#fff;color:#111;font-size:22px;
      box-shadow:0 10px 24px rgba(0,0,0,.45);
    }
    .fab.tracking{background:var(--green);color:#fff}

    /* Panels */
    .panel{
      background:var(--card);
      border-top-left-radius:24px;border-top-right-radius:24px;
      box-shadow:0 -10px 38px rgba(0,0,0,.55);
      padding:16px;
    }
    .handle{width:44px;height:4px;border-radius:999px;background:#3a3a3a;margin:0 auto 12px}
    .panel-title{display:flex;align-items:center;gap:10px;font-size:18px;font-weight:900;margin-bottom:12px}
    .row{
      display:flex;align-items:center;gap:10px;
      background:var(--card2);
      border:1px solid var(--line);
      border-radius:14px;padding:12px 12px;margin-bottom:10px;
    }
    .icon{
      width:36px;height:36px;border-radius:50%;
      display:grid;place-items:center;font-size:16px;font-weight:900;flex-shrink:0;
    }
    .icon.pick{background:rgba(0,200,83,.16);color:var(--green)}
    .icon.drop{background:rgba(255,215,0,.16);color:var(--gold)}
    .icon.phone{background:rgba(33,150,243,.16);color:var(--blue)}
    input.field{
      width:100%;
      background:transparent;border:none;outline:none;
      color:#fff;font-size:15px;
    }
    input.field::placeholder{color:#8b8b8b}

    .vehicles{
      display:flex;gap:10px;overflow-x:auto;padding:2px 0 8px;margin:8px 0 10px;
    }
    .veh{
      min-width:110px;flex:1;
      background:var(--card2);border:2px solid transparent;border-radius:16px;
      padding:12px 10px;text-align:center;cursor:pointer;
    }
    .veh.sel{border-color:var(--gold);background:rgba(255,215,0,.08)}
    .veh .vicon{font-size:28px}
    .veh .vname{font-size:13px;font-weight:800;margin-top:4px}
    .veh .vprice{font-size:14px;color:var(--gold);font-weight:900;margin-top:2px}
    .veh .veta{font-size:11px;color:var(--muted);margin-top:2px}

    .summary{
      display:none;
      border:1px solid rgba(255,215,0,.45);
      background:linear-gradient(135deg,rgba(255,215,0,.14),rgba(255,215,0,.05));
      border-radius:16px;padding:12px;margin:10px 0 12px;
    }
    .summary.show{display:block}
    .srow{display:flex;justify-content:space-between;gap:10px;padding:5px 0;color:#d3d3d3;font-size:13px}
    .srow.total{
      border-top:1px solid rgba(255,215,0,.25);
      margin-top:8px;padding-top:10px;
      font-size:17px;font-weight:1000;color:var(--gold)
    }

    .btn{
      width:100%;
      border:none;border-radius:16px;
      padding:16px;
      background:var(--gold);
      color:#111;font-size:17px;font-weight:1000;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:10px;
    }
    .btn:disabled{background:#5a5a5a;color:#1e1e1e;cursor:not-allowed}

    .footer-note{
      text-align:center;font-size:11px;color:var(--muted);
      padding:10px 0 4px;
    }

    /* Overlay Location Picker */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.97);
      z-index:3000;display:none;align-items:flex-end;justify-content:center;
      padding:0;
    }
    .overlay.show{display:flex}
    .sheet{
      width:100%;max-width:520px;max-height:100vh;
      background:#111;border-top-left-radius:22px;border-top-right-radius:22px;
      padding:14px 14px 18px;
      display:flex;flex-direction:column;
      border-top:2px solid rgba(255,215,0,.45);
    }
    .sheet-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .sheet-title{font-size:16px;font-weight:1000;color:var(--gold)}
    .sheet-close{width:36px;height:36px;border-radius:50%;border:1px solid var(--line);background:transparent;color:#fff;font-size:18px;cursor:pointer}
    .helper{color:#a8a8a8;font-size:12px;margin:8px 0 10px}
    .searchbar{
      display:flex;align-items:center;gap:10px;
      background:#171717;border:1px solid #2a2a2a;border-radius:14px;padding:10px 12px;
      margin-bottom:10px;
    }
    .searchbar input{background:transparent;border:none;outline:none;color:#fff;width:100%;font-size:14px}
    .zones{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px}
    .zpill{
      flex-shrink:0;white-space:nowrap;
      border:1px solid #3a3a3a;background:#1b1b1b;color:#fff;
      padding:8px 12px;border-radius:999px;font-size:13px;font-weight:900;cursor:pointer;
    }
    .zpill.on{border-color:var(--gold);background:rgba(255,215,0,.12);color:var(--gold)}
    .list{
      flex:1;overflow:auto;background:#141414;border:1px solid #2a2a2a;border-radius:14px;padding:8px;
    }
    .item{
      width:100%;text-align:left;
      border:1px solid #2f2f2f;background:#1e1e1e;color:#fff;
      padding:12px;border-radius:12px;font-size:14px;font-weight:800;
      cursor:pointer;margin-bottom:8px;
    }
    .item small{display:block;color:#a9a9a9;font-weight:700;margin-top:2px}
    .item:hover{border-color:var(--gold);background:#232323}

    /* Modal Searching/Tracking */
    .modal{
      position:fixed;inset:0;background:rgba(0,0,0,.92);
      z-index:2500;display:none;align-items:center;justify-content:center;padding:16px;
    }
    .modal.show{display:flex}
    .card{
      width:100%;max-width:420px;
      border:2px solid var(--gold);
      background:var(--card);border-radius:22px;
      padding:18px;text-align:center;
    }
    .big{font-size:18px;font-weight:1000;margin-bottom:8px}
    .muted{color:var(--muted);font-size:13px}
    .dots{display:flex;justify-content:center;gap:10px;margin:16px 0}
    .d{width:12px;height:12px;border-radius:50%;background:var(--gold);animation:pulse 1s infinite}
    .d:nth-child(2){animation-delay:.15s}
    .d:nth-child(3){animation-delay:.3s}
    .d:nth-child(4){animation-delay:.45s}
    .d:nth-child(5){animation-delay:.6s}
    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.15);opacity:.75}}

    .btn-alt{
      width:100%;
      margin-top:12px;
      background:transparent;border:2px solid var(--red);
      color:var(--red);border-radius:16px;padding:12px;font-weight:1000;cursor:pointer;
    }
    .track{
      display:none;
      background:var(--card);
      border-top-left-radius:24px;border-top-right-radius:24px;
      padding:16px;
      box-shadow:0 -10px 38px rgba(0,0,0,.55);
    }
    .track.show{display:block}
    .trow{display:flex;justify-content:space-between;gap:10px;padding:7px 0;border-bottom:1px solid #222}
    .trow:last-child{border-bottom:none}
    .tlabel{color:var(--muted);font-size:12px}
    .tval{font-weight:900;font-size:13px}
    .actions{display:flex;gap:10px;margin-top:12px}
    .abtn{
      flex:1;border:none;border-radius:14px;padding:14px;font-weight:1000;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:8px;
    }
    .abtn.call{background:var(--green);color:#fff}
    .abtn.cancel{background:transparent;color:var(--red);border:2px solid var(--red)}
  </style>
</head>

<body>
<div class="app">
  <header class="header">
    <div class="header-left">
      <div class="logo">üöó</div>
      <div>
        <div class="title">DIGIY DRIVER</div>
        <div class="sub">
          VTC S√©n√©gal ‚Ä¢
          <span class="pill" id="pillOnline">
            <span class="dot off" id="dotOnline"></span>
            <span id="txtOnline">Hors ligne</span>
          </span>
          <span class="pill" id="pillGPS">
            <span class="dot off" id="dotGPS"></span>
            <span id="txtGPS">GPS OFF</span>
          </span>
        </div>
      </div>
    </div>
    <div class="header-right">
      <button class="btn-sos" id="btnSOS" title="Urgence">SOS</button>
      <button class="btn-icon" id="btnMenu" title="Menu">‚ò∞</button>
    </div>
  </header>

  <div class="map-wrap">
    <div id="map"></div>
    <div class="map-actions">
      <button class="fab" id="btnLoc" title="Ma position">üìç</button>
    </div>
  </div>

  <!-- Booking panel -->
  <div class="panel" id="panelBooking">
    <div class="handle"></div>
    <div class="panel-title">üöï O√π allez-vous ?</div>

    <div class="row">
      <div class="icon pick">üìç</div>
      <input class="field" id="pickupInput" placeholder="Point de d√©part" readonly />
    </div>

    <div class="row">
      <div class="icon drop">üèÅ</div>
      <input class="field" id="dropoffInput" placeholder="Destination" readonly />
    </div>

    <div class="row">
      <div class="icon phone">üìû</div>
      <input class="field" id="clientPhone" inputmode="tel" autocomplete="tel" placeholder="T√©l√©phone WhatsApp du client" />
    </div>

    <div class="vehicles" id="vehicles">
      <div class="veh sel" data-type="eco" data-m="1">
        <div class="vicon">üöó</div>
        <div class="vname">√âco</div>
        <div class="vprice" id="pEco">‚Äî</div>
        <div class="veta">3 min</div>
      </div>
      <div class="veh" data-type="confort" data-m="1.3">
        <div class="vicon">üöô</div>
        <div class="vname">Confort</div>
        <div class="vprice" id="pConfort">‚Äî</div>
        <div class="veta">5 min</div>
      </div>
      <div class="veh" data-type="premium" data-m="1.8">
        <div class="vicon">üöò</div>
        <div class="vname">Premium</div>
        <div class="vprice" id="pPremium">‚Äî</div>
        <div class="veta">8 min</div>
      </div>
      <div class="veh" data-type="moto" data-m="0.7">
        <div class="vicon">üèçÔ∏è</div>
        <div class="vname">Moto</div>
        <div class="vprice" id="pMoto">‚Äî</div>
        <div class="veta">2 min</div>
      </div>
    </div>

    <div class="summary" id="summary">
      <div class="srow"><span>Distance estim√©e</span><span id="sDistance">‚Äî</span></div>
      <div class="srow"><span>Dur√©e estim√©e</span><span id="sDuration">‚Äî</span></div>
      <div class="srow"><span>V√©hicule</span><span id="sVeh">√âco</span></div>
      <div class="srow total"><span>Total</span><span id="sTotal">‚Äî</span></div>
    </div>

    <button class="btn" id="btnConfirm" disabled>üöï Commander ma course</button>

    <div class="footer-note">
      üí∞ Paiement au chauffeur ‚Ä¢ 0% commission ‚Ä¢ <a href="https://digiylyfe.com/page-inscription-digiy/">Devenir chauffeur</a>
    </div>
  </div>

  <!-- Tracking panel -->
  <div class="track" id="panelTrack">
    <div class="handle"></div>
    <div class="panel-title">üõ∞Ô∏è Suivi de course</div>
    <div class="trow"><span class="tlabel">Statut</span><span class="tval" id="tStatus">‚Äî</span></div>
    <div class="trow"><span class="tlabel">Chauffeur</span><span class="tval" id="tDriver">‚Äî</span></div>
    <div class="trow"><span class="tlabel">V√©hicule</span><span class="tval" id="tCar">‚Äî</span></div>
    <div class="trow"><span class="tlabel">T√©l√©phone</span><span class="tval" id="tPhone">‚Äî</span></div>
    <div class="trow"><span class="tlabel">Prix</span><span class="tval" id="tPrice" style="color:var(--gold)">‚Äî</span></div>

    <div class="actions">
      <button class="abtn call" id="btnCall">üìû Appeler</button>
      <button class="abtn cancel" id="btnCancelRide">‚úï Annuler</button>
    </div>
  </div>
</div>

<!-- Location overlay -->
<div class="overlay" id="overlay">
  <div class="sheet">
    <div class="sheet-head">
      <div class="sheet-title" id="overlayTitle">Choisir un lieu</div>
      <button class="sheet-close" id="btnCloseOverlay">‚úï</button>
    </div>

    <div class="helper">Tu peux chercher. Si le lieu n‚Äôexiste pas ‚Üí <b>PIN no-limit</b> en cliquant sur la carte.</div>

    <div class="searchbar">
      <span style="opacity:.85">üîé</span>
      <input id="placeSearch" placeholder="Tape un lieu (ex: Plateau, Saly, AIBD...)" />
    </div>

    <div class="zones" id="zones"></div>
    <div class="list" id="list"></div>
  </div>
</div>

<!-- Searching modal -->
<div class="modal" id="modalSearching">
  <div class="card">
    <div class="big">Recherche d‚Äôun chauffeur‚Ä¶</div>
    <div class="muted">On diffuse ta demande aux chauffeurs disponibles √† proximit√©.</div>
    <div class="dots"><div class="d"></div><div class="d"></div><div class="d"></div><div class="d"></div><div class="d"></div></div>
    <button class="btn-alt" id="btnCancelSearch">‚úï Annuler la recherche</button>
  </div>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Supabase -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  /* üîê SUPABASE ‚Äî D√âJ√Ä POS√â */
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Tables (Supabase)
  const T_PLACES = "geo_places";
  const T_RIDES  = "ride_requests";
  const T_DLOC   = "driver_locations"; // optionnel (markers chauffeurs)

  // Pricing (terrain)
  const PRICE_PER_KM = 400;
  const MIN_PRICE = 1000;

  // UI refs
  const pillOnline = document.getElementById("pillOnline");
  const dotOnline  = document.getElementById("dotOnline");
  const txtOnline  = document.getElementById("txtOnline");

  const dotGPS = document.getElementById("dotGPS");
  const txtGPS = document.getElementById("txtGPS");

  const pickupInput = document.getElementById("pickupInput");
  const dropoffInput = document.getElementById("dropoffInput");
  const clientPhoneEl = document.getElementById("clientPhone");

  const summary = document.getElementById("summary");
  const sDistance = document.getElementById("sDistance");
  const sDuration = document.getElementById("sDuration");
  const sVeh = document.getElementById("sVeh");
  const sTotal = document.getElementById("sTotal");

  const pEco = document.getElementById("pEco");
  const pConfort = document.getElementById("pConfort");
  const pPremium = document.getElementById("pPremium");
  const pMoto = document.getElementById("pMoto");

  const btnConfirm = document.getElementById("btnConfirm");
  const modalSearching = document.getElementById("modalSearching");
  const btnCancelSearch = document.getElementById("btnCancelSearch");

  const panelBooking = document.getElementById("panelBooking");
  const panelTrack = document.getElementById("panelTrack");
  const tStatus = document.getElementById("tStatus");
  const tDriver = document.getElementById("tDriver");
  const tCar = document.getElementById("tCar");
  const tPhone = document.getElementById("tPhone");
  const tPrice = document.getElementById("tPrice");
  const btnCall = document.getElementById("btnCall");
  const btnCancelRide = document.getElementById("btnCancelRide");

  const btnLoc = document.getElementById("btnLoc");
  const btnSOS = document.getElementById("btnSOS");

  const overlay = document.getElementById("overlay");
  const overlayTitle = document.getElementById("overlayTitle");
  const btnCloseOverlay = document.getElementById("btnCloseOverlay");
  const zonesEl = document.getElementById("zones");
  const listEl = document.getElementById("list");
  const placeSearch = document.getElementById("placeSearch");

  // App state
  let map;
  let pickupMarker=null, dropoffMarker=null, routeLine=null;
  let myMarker=null;
  let myPos=null;
  let gpsWatch=null;
  let trackingGPS=false;

  let pinModeFor = null; // "pickup" | "dropoff"

  let PLACES = [];
  let ZONES = []; // [{id,label,filterFn}]
  let currentPlaceType = "pickup"; // overlay context

  let booking = {
    pickup: null,
    pickupName: "",
    dropoff: null,
    dropoffName: "",
    vehicleType: "eco",
    multiplier: 1,
    distanceKm: 0,
    durationMin: 0,
    price: 0
  };

  let rideId = null;
  let rideChannel = null;
  let driversChannel = null;
  let driverMarkers = new Map(); // phone -> marker

  // -------------------------
  // Helpers
  // -------------------------
  function setOnline(ok){
    dotOnline.classList.toggle("on", ok);
    dotOnline.classList.toggle("off", !ok);
    txtOnline.textContent = ok ? "En ligne" : "Hors ligne";
  }

  function setGPS(ok){
    dotGPS.classList.toggle("on", ok);
    dotGPS.classList.toggle("off", !ok);
    txtGPS.textContent = ok ? "GPS ON" : "GPS OFF";
    btnLoc.classList.toggle("tracking", ok);
  }

  function money(n){
    const v = Math.round(Number(n||0));
    return v.toLocaleString("fr-FR") + " F";
  }

  function distKm(a,b){
    const R = 6371;
    const dLat = (b.lat-a.lat)*Math.PI/180;
    const dLng = (b.lng-a.lng)*Math.PI/180;
    const aa = Math.sin(dLat/2)**2 +
      Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;
    const c = 2*Math.atan2(Math.sqrt(aa), Math.sqrt(1-aa));
    return R*c;
  }

  function showOverlay(type){
    currentPlaceType = type;
    overlayTitle.textContent = (type==="pickup") ? "Choisir le point de d√©part" : "Choisir la destination";
    overlay.classList.add("show");
    placeSearch.value = "";
    renderZones();
    if(ZONES[0]) setZoneActive(ZONES[0].id);
    renderList(getPlacesForZone(ZONES[0]?.id), "");
    placeSearch.focus();
  }

  function hideOverlay(){
    overlay.classList.remove("show");
  }

  function enablePinMode(which){
    pinModeFor = which;
    hideOverlay();
    alert("Lieu introuvable. üëâ Clique sur la carte pour poser un PIN (no limit).");
  }

  // -------------------------
  // Supabase
  // -------------------------
  async function pingSupabase(){
    try{
      const { error } = await supabase.from(T_PLACES).select("id").limit(1);
      setOnline(!error);
      if(error) console.error(error);
    }catch(e){
      console.error(e);
      setOnline(false);
    }
  }

  async function loadPlacesSN(){
    const { data, error } = await supabase
      .from(T_PLACES)
      .select("id,country,region,department,city,zone,name,lat,lng,tags,is_active")
      .eq("country","SN")
      .eq("is_active", true)
      .limit(20000);

    if(error){
      console.error(error);
      alert("Erreur chargement zones (geo_places). V√©rifie la table + RLS.");
      return;
    }
    PLACES = (data || []).map(p => ({
      ...p,
      lat: Number(p.lat),
      lng: Number(p.lng),
      name: String(p.name || ""),
      region: p.region ? String(p.region) : "",
      zone: p.zone ? String(p.zone) : "",
      city: p.city ? String(p.city) : ""
    }));

    buildZonesFromPlaces();
  }

  function buildZonesFromPlaces(){
    // Zones ‚Äúintelligentes‚Äù : Dakar / Petite C√¥te / A√©roports / Autres + toutes les r√©gions
    const byRegion = new Map();
    for(const p of PLACES){
      const r = (p.region || "Autres").trim() || "Autres";
      byRegion.set(r, (byRegion.get(r)||0) + 1);
    }

    const has = (txt)=> (p)=> p.name.toLowerCase().includes(txt) || (p.zone||"").toLowerCase().includes(txt);

    const z = [];
    z.push({ id:"aero", label:"‚úàÔ∏è A√©roports", filter: (p)=> /aibd|a√©roport|lss|diass/i.test(p.name) });
    z.push({ id:"dakar", label:"üèôÔ∏è Dakar", filter: (p)=> (p.region||"").toLowerCase()==="dakar" });
    z.push({ id:"petitecote", label:"üèñÔ∏è Petite C√¥te", filter: (p)=> /(saly|somone|ngaparou|mbour|joal|popenguine|warang|nianing|ngu[√©e]khokh)/i.test(p.name) || (p.region||"").toLowerCase()==="thi√®s" });
    z.push({ id:"thies", label:"üèôÔ∏è Thi√®s", filter: (p)=> (p.region||"").toLowerCase()==="thi√®s" });
    z.push({ id:"all", label:"üåç Tout SN", filter: (_)=> true });

    // Ajoute r√©gions en plus (no limit)
    const regionsSorted = [...byRegion.keys()].sort((a,b)=> a.localeCompare(b, "fr"));
    for(const r of regionsSorted){
      if(r.toLowerCase()==="dakar" || r.toLowerCase()==="thi√®s") continue;
      z.push({
        id:`reg_${r.toLowerCase().replace(/\s+/g,"_")}`,
        label:`üìç ${r}`,
        filter:(p)=> (p.region||"").toLowerCase()===r.toLowerCase()
      });
    }

    ZONES = z;
  }

  // -------------------------
  // Zones UI
  // -------------------------
  function renderZones(){
    zonesEl.innerHTML = "";
    for(const zone of ZONES){
      const b = document.createElement("button");
      b.className = "zpill";
      b.textContent = zone.label;
      b.dataset.id = zone.id;
      b.onclick = ()=> {
        setZoneActive(zone.id);
        renderList(getPlacesForZone(zone.id), placeSearch.value.trim());
      };
      zonesEl.appendChild(b);
    }
  }

  function setZoneActive(id){
    zonesEl.querySelectorAll(".zpill").forEach(x => x.classList.toggle("on", x.dataset.id===id));
  }

  function getPlacesForZone(zoneId){
    const z = ZONES.find(x=>x.id===zoneId) || ZONES.find(x=>x.id==="all");
    const arr = PLACES.filter(p=> z.filter(p));
    // tri simple
    arr.sort((a,b)=> a.name.localeCompare(b.name,"fr"));
    return arr;
  }

  function renderList(places, q){
    const query = (q||"").toLowerCase();
    const filtered = query
      ? places.filter(p=> p.name.toLowerCase().includes(query) || (p.zone||"").toLowerCase().includes(query) || (p.city||"").toLowerCase().includes(query)).slice(0,300)
      : places.slice(0,300);

    listEl.innerHTML = "";

    // Bouton PIN no-limit (toujours dispo)
    const pinBtn = document.createElement("button");
    pinBtn.className = "item";
    pinBtn.innerHTML = `üìå Poser un PIN sur la carte <small>Si ton lieu n‚Äôexiste pas encore</small>`;
    pinBtn.onclick = ()=> enablePinMode(currentPlaceType);
    listEl.appendChild(pinBtn);

    if(!filtered.length){
      const empty = document.createElement("div");
      empty.style.padding="14px";
      empty.style.color="#a9a9a9";
      empty.textContent="Aucun lieu trouv√© ici. Utilise le PIN no-limit.";
      listEl.appendChild(empty);
      return;
    }

    for(const p of filtered){
      const btn = document.createElement("button");
      btn.className = "item";
      btn.innerHTML = `${p.name}<small>${[p.zone,p.city,p.region].filter(Boolean).join(" ‚Ä¢ ")}</small>`;
      btn.onclick = ()=> choosePlace(p);
      listEl.appendChild(btn);
    }
  }

  function choosePlace(p){
    const coords = { lat: p.lat, lng: p.lng };
    if(currentPlaceType==="pickup"){
      booking.pickup = coords;
      booking.pickupName = p.name;
      pickupInput.value = p.name;
      addPickupMarker(coords.lat, coords.lng);
    } else {
      booking.dropoff = coords;
      booking.dropoffName = p.name;
      dropoffInput.value = p.name;
      addDropoffMarker(coords.lat, coords.lng);
    }
    hideOverlay();
    checkReady();
  }

  // -------------------------
  // Map
  // -------------------------
  function initMap(){
    const centerSN = [14.4974, -14.4524];
    map = L.map("map", { center:centerSN, zoom:7, zoomControl:true });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19, minZoom: 6,
      attribution: "¬© DIGIY DRIVER"
    }).addTo(map);

    map.on("click", (e)=>{
      if(!pinModeFor) return;

      const coords = { lat: e.latlng.lat, lng: e.latlng.lng };
      if(pinModeFor==="pickup"){
        booking.pickup = coords;
        booking.pickupName = "Point choisi sur la carte";
        pickupInput.value = booking.pickupName;
        addPickupMarker(coords.lat, coords.lng);
      } else {
        booking.dropoff = coords;
        booking.dropoffName = "Destination choisie sur la carte";
        dropoffInput.value = booking.dropoffName;
        addDropoffMarker(coords.lat, coords.lng);
      }

      pinModeFor = null;
      checkReady();
    });
  }

  function addPickupMarker(lat,lng){
    if(pickupMarker) map.removeLayer(pickupMarker);
    pickupMarker = L.marker([lat,lng]).addTo(map);
  }

  function addDropoffMarker(lat,lng){
    if(dropoffMarker) map.removeLayer(dropoffMarker);
    dropoffMarker = L.marker([lat,lng]).addTo(map);
  }

  function drawRoute(){
    if(routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline([[booking.pickup.lat,booking.pickup.lng],[booking.dropoff.lat,booking.dropoff.lng]], {
      color: "#FFD700", weight: 4, opacity: .85, dashArray:"10,10"
    }).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding:[40,40] });
  }

  // -------------------------
  // GPS
  // -------------------------
  function startGPS(){
    if(!navigator.geolocation){
      alert("GPS non support√©.");
      return;
    }
    const opt = { enableHighAccuracy:true, timeout:10000, maximumAge:0 };

    gpsWatch = navigator.geolocation.watchPosition((pos)=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      myPos = { lat, lng, acc: pos.coords.accuracy };

      if(!myMarker){
        myMarker = L.circleMarker([lat,lng], { radius:8 }).addTo(map);
      } else {
        myMarker.setLatLng([lat,lng]);
      }

      setGPS(true);

      // auto pickup si vide
      if(!booking.pickup){
        booking.pickup = { lat, lng };
        booking.pickupName = "Ma position actuelle";
        pickupInput.value = booking.pickupName;
        addPickupMarker(lat,lng);
        checkReady();
      }

      // si course active ‚Üí update position client
      if(rideId){
        supabase.from(T_RIDES)
          .update({ client_lat: lat, client_lng: lng })
          .eq("id", rideId)
          .then(()=>{})
          .catch(()=>{});
      }
    }, (err)=>{
      console.error(err);
      setGPS(false);
    }, opt);

    trackingGPS = true;
  }

  function stopGPS(){
    if(gpsWatch) navigator.geolocation.clearWatch(gpsWatch);
    gpsWatch = null;
    trackingGPS = false;
    setGPS(false);
  }

  function centerMe(){
    if(myPos){
      map.setView([myPos.lat,myPos.lng], 15);
    } else {
      alert("Position pas encore disponible.");
    }
  }

  // -------------------------
  // Pricing & booking
  // -------------------------
  function updateVehicleUI(){
    document.querySelectorAll(".veh").forEach(v=>{
      v.classList.toggle("sel", v.dataset.type===booking.vehicleType);
    });
    const name = document.querySelector(".veh.sel .vname")?.textContent || "√âco";
    sVeh.textContent = name;
  }

  function updatePrices(){
    if(!booking.pickup || !booking.dropoff) return;

    let d = distKm(booking.pickup, booking.dropoff);
    d = d * 1.3; // marge route r√©elle
    booking.distanceKm = d;

    booking.durationMin = Math.max(2, Math.round(d/30*60)); // base 30km/h
    const base = Math.max(MIN_PRICE, Math.round(d * PRICE_PER_KM / 100) * 100);

    pEco.textContent = money(base);
    pConfort.textContent = money(Math.round(base*1.3/100)*100);
    pPremium.textContent = money(Math.round(base*1.8/100)*100);
    pMoto.textContent = money(Math.round(base*0.7/100)*100);

    booking.price = Math.round((base * booking.multiplier)/100) * 100;

    summary.classList.add("show");
    sDistance.textContent = booking.distanceKm.toFixed(1) + " km";
    sDuration.textContent = booking.durationMin + " min";
    sTotal.textContent = booking.price.toLocaleString("fr-FR") + " FCFA";

    btnConfirm.disabled = false;

    drawRoute();
  }

  function checkReady(){
    if(booking.pickup && booking.dropoff){
      updatePrices();
    }
  }

  // -------------------------
  // Ride requests (Supabase)
  // -------------------------
  async function createRide(){
    const clientPhone = (clientPhoneEl.value || "").trim() || null;

    const payload = {
      status: "searching",
      pickup_name: booking.pickupName || "Point de d√©part",
      pickup_lat: booking.pickup.lat,
      pickup_lng: booking.pickup.lng,
      dropoff_name: booking.dropoffName || "Destination",
      dropoff_lat: booking.dropoff.lat,
      dropoff_lng: booking.dropoff.lng,
      distance_km: booking.distanceKm,
      duration_min: booking.durationMin,
      price_f: booking.price,
      vehicle_type: booking.vehicleType,
      client_phone: clientPhone,
      client_lat: myPos?.lat ?? booking.pickup.lat,
      client_lng: myPos?.lng ?? booking.pickup.lng
    };

    modalSearching.classList.add("show");

    const { data, error } = await supabase
      .from(T_RIDES)
      .insert(payload)
      .select("id,status,price_f")
      .single();

    if(error){
      console.error(error);
      modalSearching.classList.remove("show");
      alert("Erreur cr√©ation course (ride_requests). V√©rifie table/RLS.");
      return;
    }

    rideId = data.id;
    subscribeRide(rideId);
  }

  function subscribeRide(id){
    if(rideChannel){
      supabase.removeChannel(rideChannel);
      rideChannel = null;
    }

    rideChannel = supabase.channel("ride_"+id);

    rideChannel.on("postgres_changes", {
      event: "UPDATE",
      schema: "public",
      table: T_RIDES,
      filter: `id=eq.${id}`
    }, (payload)=>{
      const r = payload.new;
      handleRideUpdate(r);
    });

    rideChannel.subscribe(async (status)=>{
      if(status === "SUBSCRIBED"){
        // fetch initial
        const { data } = await supabase.from(T_RIDES).select("*").eq("id", id).single();
        if(data) handleRideUpdate(data);
      }
    });
  }

  function handleRideUpdate(r){
    // statuses: searching, accepted, arrived, in_progress, completed, cancelled
    if(!r) return;

    if(r.status === "accepted" || r.status === "arrived" || r.status === "in_progress"){
      modalSearching.classList.remove("show");
      panelBooking.style.display = "none";
      panelTrack.classList.add("show");

      tStatus.textContent = (r.status || "‚Äî");
      tDriver.textContent = r.assigned_driver_name || "‚Äî";
      tCar.textContent = r.assigned_driver_vehicle
        ? `${r.assigned_driver_vehicle}${r.assigned_driver_plate ? " ‚Ä¢ " + r.assigned_driver_plate : ""}`
        : "‚Äî";
      tPhone.textContent = r.assigned_driver_phone || "‚Äî";
      tPrice.textContent = (r.price_f ? r.price_f.toLocaleString("fr-FR") : booking.price.toLocaleString("fr-FR")) + " FCFA";

      // driver marker if coords available
      if(r.driver_lat && r.driver_lng){
        upsertDriverMarker(r.assigned_driver_phone || "driver", Number(r.driver_lat), Number(r.driver_lng), true);
      }
    }

    if(r.status === "searching"){
      // still searching (modal stays)
    }

    if(r.status === "completed"){
      modalSearching.classList.remove("show");
      alert("‚úÖ Course termin√©e. Merci DIGIY DRIVER !");
      resetAll();
    }

    if(r.status === "cancelled"){
      modalSearching.classList.remove("show");
      alert("‚ùå Course annul√©e.");
      resetAll();
    }
  }

  async function cancelRide(reason){
    if(!rideId) return;
    await supabase
      .from(T_RIDES)
      .update({ status:"cancelled", cancelled_by:"client", cancel_reason: reason || "client_cancel" })
      .eq("id", rideId);
  }

  function resetAll(){
    if(rideChannel){
      supabase.removeChannel(rideChannel);
      rideChannel = null;
    }
    rideId = null;

    panelTrack.classList.remove("show");
    panelBooking.style.display = "block";

    // keep pickup maybe, but clean status
    // (tu peux choisir)
  }

  // -------------------------
  // Drivers online markers (optionnel)
  // -------------------------
  function upsertDriverMarker(phone, lat, lng, focus=false){
    const key = phone || ("drv_"+Math.random());
    let m = driverMarkers.get(key);
    if(!m){
      const icon = L.divIcon({
        className:"driver-marker",
        html:`<div style="
          background:#00C853;width:30px;height:30px;border-radius:50%;
          display:flex;align-items:center;justify-content:center;
          border:2px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,.3);
          font-weight:900;color:#111
        ">üöó</div>`,
        iconSize:[30,30], iconAnchor:[15,15]
      });
      m = L.marker([lat,lng], { icon }).addTo(map);
      driverMarkers.set(key, m);
    }else{
      m.setLatLng([lat,lng]);
    }
    if(focus) map.setView([lat,lng], 14);
  }

  function removeDriverMarker(phone){
    const m = driverMarkers.get(phone);
    if(m){
      map.removeLayer(m);
      driverMarkers.delete(phone);
    }
  }

  function subscribeDrivers(){
    // Ne plante pas si table absente : on tente, si error => on ignore
    driversChannel = supabase.channel("drivers_online");

    driversChannel.on("postgres_changes", {
      event: "*",
      schema: "public",
      table: T_DLOC
    }, (payload)=>{
      const row = payload.new || payload.old;
      if(!row) return;

      const phone = row.driver_phone || row.phone || row.id || "driver";
      const lat = Number(row.lat);
      const lng = Number(row.lng);
      const online = row.is_online ?? row.available ?? true;

      if(!online){
        removeDriverMarker(phone);
        return;
      }
      if(Number.isFinite(lat) && Number.isFinite(lng)){
        upsertDriverMarker(phone, lat, lng, false);
      }
    });

    driversChannel.subscribe(async (status)=>{
      if(status !== "SUBSCRIBED") return;
      // charge initial
      const { data, error } = await supabase
        .from(T_DLOC)
        .select("driver_phone,lat,lng,is_online")
        .eq("is_online", true)
        .limit(200);

      if(error){
        // table pas l√† ou RLS => on ignore sans casser l‚Äôapp
        return;
      }
      (data||[]).forEach(d=>{
        if(Number.isFinite(Number(d.lat)) && Number.isFinite(Number(d.lng))){
          upsertDriverMarker(d.driver_phone, Number(d.lat), Number(d.lng), false);
        }
      });
    });
  }

  // -------------------------
  // SOS (simple)
  // -------------------------
  btnSOS.addEventListener("click", ()=>{
    const lat = myPos?.lat;
    const lng = myPos?.lng;
    const msg = lat && lng ? `URGENCE ‚Äî Position: ${lat.toFixed(6)}, ${lng.toFixed(6)}` : "URGENCE ‚Äî Position inconnue";
    alert(msg + "\n\n(Appel d‚Äôurgence: 17)");
    window.location.href = "tel:17";
  });

  // -------------------------
  // Events
  // -------------------------
  pickupInput.addEventListener("click", ()=> showOverlay("pickup"));
  dropoffInput.addEventListener("click", ()=> showOverlay("dropoff"));

  btnCloseOverlay.addEventListener("click", hideOverlay);
  overlay.addEventListener("click", (e)=>{ if(e.target === overlay) hideOverlay(); });

  placeSearch.addEventListener("input", ()=>{
    const activeId = zonesEl.querySelector(".zpill.on")?.dataset?.id || ZONES[0]?.id || "all";
    renderList(getPlacesForZone(activeId), placeSearch.value.trim());
  });

  document.getElementById("vehicles").addEventListener("click", (e)=>{
    const el = e.target.closest(".veh");
    if(!el) return;
    booking.vehicleType = el.dataset.type;
    booking.multiplier = Number(el.dataset.m);
    updateVehicleUI();
    if(booking.pickup && booking.dropoff) updatePrices();
  });

  btnConfirm.addEventListener("click", async ()=>{
    if(btnConfirm.disabled) return;
    await createRide();
  });

  btnCancelSearch.addEventListener("click", async ()=>{
    modalSearching.classList.remove("show");
    if(rideId) await cancelRide("search_cancelled");
  });

  btnLoc.addEventListener("click", ()=>{
    if(!trackingGPS){
      startGPS();
      setGPS(true);
    }else{
      centerMe();
    }
  });

  btnCall.addEventListener("click", ()=>{
    const phone = tPhone.textContent.trim();
    if(!phone || phone==="‚Äî"){ alert("T√©l√©phone chauffeur indisponible."); return; }
    window.location.href = `tel:${phone}`;
  });

  btnCancelRide.addEventListener("click", async ()=>{
    if(!rideId){ alert("Aucune course active."); return; }
    if(confirm("Annuler la course ?")){
      await cancelRide("client_cancel");
    }
  });

  // -------------------------
  // Boot
  // -------------------------
  async function boot(){
    initMap();
    await pingSupabase();
    await loadPlacesSN();

    // zones UI initial
    renderZones();
    if(ZONES[0]) setZoneActive(ZONES[0].id);
    renderList(getPlacesForZone(ZONES[0]?.id), "");

    // GPS auto (tu peux enlever si tu veux)
    startGPS();

    // markers chauffeurs (optionnel)
    subscribeDrivers();

    updateVehicleUI();
  }

  boot();
</script>
</body>
</html>
