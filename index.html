<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>DIGIY DRIVER ‚Äî Commander une course</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#F8FAF6">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#F8FAF6;--card:#fff;--line:#E5E7EB;
  --text:#111827;--muted:#6B7280;
  --gold:#EAB308;--green:#16A34A;--red:#EF4444;
  --radius:18px;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:var(--bg);color:var(--text);
}
header{
  padding:14px;border-bottom:1px solid var(--line);
  background:#fff;font-weight:900;
}
#map{height:45vh}
.panel{
  padding:14px;
}
.card{
  background:var(--card);border:1px solid var(--line);
  border-radius:var(--radius);padding:14px;margin-bottom:12px;
}
input,button{
  width:100%;padding:12px;border-radius:14px;
  border:1px solid var(--line);font-size:15px;
}
button{
  background:linear-gradient(135deg,#FFF7D6,#FDE68A);
  font-weight:900;cursor:pointer;border:none;
}
.zone{
  padding:10px;border-radius:12px;border:1px solid var(--line);
  margin-bottom:6px;font-weight:800;cursor:pointer;
}
.zone:hover{background:#F9FAFB}
#overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.85);
  display:none;z-index:999;align-items:flex-end;
}
#overlay.show{display:flex}
#overlay .card{width:100%;max-height:80vh;overflow:auto}
</style>
</head>

<body>

<header>üöï DIGIY DRIVER ‚Äî Commander</header>

<div id="map"></div>

<div class="panel">

  <div class="card">
    <input id="pickupInput" readonly placeholder="üìç Point de d√©part">
    <div style="height:8px"></div>
    <input id="dropoffInput" readonly placeholder="üèÅ Destination">
  </div>

  <div class="card">
    <input id="clientPhone" placeholder="üìû T√©l√©phone client (+221‚Ä¶)" />
  </div>

  <button id="btnOrder">Commander la course</button>

  <div id="msg" style="margin-top:10px;font-weight:800;color:#374151"></div>
</div>

<!-- OVERLAY ZONES -->
<div id="overlay">
  <div class="card">
    <h3 id="overlayTitle">Choisir un lieu</h3>
    <div id="zoneList"></div>
    <button onclick="closeOverlay()" style="margin-top:10px;background:#fff;border:1px solid #ccc">Fermer</button>
  </div>
</div>

<script>
(function(){
'use strict';

/* üîê SUPABASE */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* DOM */
const pickupInput = document.getElementById("pickupInput");
const dropoffInput = document.getElementById("dropoffInput");
const clientPhone = document.getElementById("clientPhone");
const msg = document.getElementById("msg");
const overlay = document.getElementById("overlay");
const zoneList = document.getElementById("zoneList");
const overlayTitle = document.getElementById("overlayTitle");

/* MAP */
const map = L.map('map').setView([14.4974,-14.4524],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19
}).addTo(map);

/* ZONES NATIONALES (BASE ‚Äî extensible infini) */
const ZONES = [
 "Dakar Plateau","Dakar Almadies","Yoff","Ouakam","Pikine","Gu√©diawaye",
 "Rufisque","Diamniadio","Thi√®s Centre","Mbour Centre",
 "Saly Centre","Ngaparou","Somone","Joal","Saint-Louis",
 "Kaolack","Touba","Ziguinchor","Tambacounda"
];

let currentField = null;

/* PICKER */
function openOverlay(field){
  currentField = field;
  overlayTitle.textContent = field==="pickup" ? "Point de d√©part" : "Destination";
  zoneList.innerHTML = "";
  ZONES.forEach(z=>{
    const d=document.createElement("div");
    d.className="zone";
    d.textContent=z;
    d.onclick=()=>selectZone(z);
    zoneList.appendChild(d);
  });
  overlay.classList.add("show");
}
function closeOverlay(){ overlay.classList.remove("show"); }

function selectZone(name){
  if(currentField==="pickup") pickupInput.value=name;
  if(currentField==="dropoff") dropoffInput.value=name;
  closeOverlay();
}

/* EXPOSE GLOBAL (BUG FIX) */
window.openOverlay = openOverlay;
window.closeOverlay = closeOverlay;

/* EVENTS */
pickupInput.addEventListener("click",()=>openOverlay("pickup"));
dropoffInput.addEventListener("click",()=>openOverlay("dropoff"));

/* COMMANDER */
document.getElementById("btnOrder").onclick = async ()=>{
  msg.textContent="‚è≥ Envoi‚Ä¶";

  if(!pickupInput.value || !dropoffInput.value){
    msg.textContent="‚ö†Ô∏è Choisis d√©part et destination";
    return;
  }

  const phone = clientPhone.value.trim() || null;

  const { error } = await sb.from("ride_requests").insert({
    status:"new",
    city:"Dakar",
    pickup_text:pickupInput.value,
    dropoff_text:dropoffInput.value,
    client_phone:phone,
    payment_mode:"cash",
    pax:1,
    vehicle_type:"eco"
  });

  if(error){
    msg.textContent="‚ùå Erreur : "+error.message;
  }else{
    msg.textContent="‚úÖ Course envoy√©e. En attente chauffeur‚Ä¶";
  }
};

})();
</script>

</body>
</html>
