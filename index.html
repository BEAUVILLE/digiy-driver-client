<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>DIGIY DRIVER ‚Äî Commander une course</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="Commandez votre VTC au S√©n√©gal - Prix justes, chauffeurs pros, 0% commission">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg: #0a0a0a;
      --card: #1a1a1a;
      --card-light: #252525;
      --gold: #FFD700;
      --gold-dark: #C7A008;
      --white: #ffffff;
      --gray: #888888;
      --gray-light: #b0b0b0;
      --green: #00C853;
      --red: #FF5252;
      --blue: #2196F3;
      --orange: #FF9800;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',system-ui,sans-serif}
    body{background:var(--bg);color:var(--white);min-height:100vh;overflow-x:hidden}

    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.1);opacity:.8}}
    @keyframes ripple{0%{transform:scale(1);opacity:.8}100%{transform:scale(3);opacity:0}}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    @keyframes sosPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,82,82,.7)}50%{box-shadow:0 0 0 20px rgba(255,82,82,0)}}
    @keyframes gpsActive{0%,100%{opacity:1}50%{opacity:.5}}

    .app{min-height:100vh;display:flex;flex-direction:column}
    .header{
      background:linear-gradient(135deg,#1a1a1a,#252525);
      padding:15px 20px;border-bottom:2px solid var(--gold);
      display:flex;justify-content:space-between;align-items:center;z-index:100
    }
    .header-left{display:flex;align-items:center;gap:10px}
    .header-logo{font-size:28px}
    .header-title{font-size:18px;font-weight:800;color:var(--gold)}
    .header-sub{font-size:11px;color:var(--gray);display:flex;align-items:center;gap:5px}
    .gps-indicator{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600}
    .gps-indicator.active{background:rgba(0,200,83,.2);color:var(--green)}
    .gps-indicator.active .gps-dot{width:6px;height:6px;background:var(--green);border-radius:50%;animation:gpsActive 1s infinite}
    .gps-indicator.inactive{background:rgba(255,82,82,.2);color:var(--red)}
    .header-right{display:flex;align-items:center;gap:10px}
    .menu-btn{background:var(--card-light);border:none;color:var(--white);width:40px;height:40px;border-radius:10px;font-size:20px;cursor:pointer}
    .sos-btn{
      background:var(--red);border:none;color:var(--white);
      width:45px;height:45px;border-radius:50%;
      font-size:12px;font-weight:800;cursor:pointer;
      animation:sosPulse 2s infinite;transition:transform .2s
    }
    .sos-btn:active{transform:scale(.95)}
    .map-container{flex:1;position:relative;min-height:300px}
    #map{width:100%;height:100%;position:absolute;top:0;left:0}

    .map-buttons{position:absolute;bottom:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:500}
    .my-location-btn{
      width:50px;height:50px;background:var(--white);border:none;border-radius:50%;
      font-size:24px;cursor:pointer;box-shadow:0 4px 15px rgba(0,0,0,.3)
    }
    .my-location-btn.tracking{background:var(--green);color:#fff}

    .sb-status{
      position:absolute;top:10px;left:10px;background:var(--card);
      padding:8px 12px;border-radius:20px;font-size:11px;display:flex;align-items:center;gap:6px;
      z-index:500;border:1px solid var(--card-light)
    }
    .sb-status .status-dot{width:8px;height:8px;border-radius:50%}
    .sb-status.connected .status-dot{background:var(--green)}
    .sb-status.disconnected .status-dot{background:var(--red)}

    .booking-panel{
      background:var(--card);border-top-left-radius:25px;border-top-right-radius:25px;
      padding:20px;box-shadow:0 -10px 40px rgba(0,0,0,.5);animation:slideUp .5s ease
    }
    .panel-handle{width:40px;height:4px;background:var(--gray);border-radius:2px;margin:0 auto 20px}
    .panel-title{font-size:20px;font-weight:700;margin-bottom:20px;display:flex;align-items:center;gap:10px}

    .input-group{margin-bottom:15px}
    .input-row{display:flex;align-items:center;background:var(--card-light);border-radius:12px;padding:12px 15px;gap:12px}
    .input-icon{width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
    .input-icon.pickup{background:rgba(0,200,83,.2);color:var(--green)}
    .input-icon.dropoff{background:rgba(255,215,0,.2);color:var(--gold)}
    .input-field{flex:1;background:none;border:none;color:var(--white);font-size:15px;outline:none}
    .input-field::placeholder{color:var(--gray)}
    .input-divider{width:2px;height:20px;background:var(--gray);margin-left:17px;margin-top:10px;margin-bottom:10px;border-radius:10px}

    .vehicle-options{display:flex;gap:10px;margin-bottom:20px;overflow-x:auto;padding-bottom:5px}
    .vehicle-option{
      flex:1;min-width:100px;background:var(--card-light);
      border:2px solid transparent;border-radius:15px;padding:15px 10px;text-align:center;
      cursor:pointer;transition:all .3s
    }
    .vehicle-option.selected{border-color:var(--gold);background:rgba(255,215,0,.1)}
    .vehicle-icon{font-size:30px;margin-bottom:5px}
    .vehicle-name{font-size:13px;font-weight:600;margin-bottom:3px}
    .vehicle-price{font-size:14px;color:var(--gold);font-weight:700}
    .vehicle-time{font-size:11px;color:var(--gray)}

    .price-summary{
      background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(255,215,0,.05));
      border:1px solid var(--gold);border-radius:15px;padding:15px;margin-bottom:20px;
      display:none
    }
    .price-summary.show{display:block;animation:fadeIn .3s ease}
    .price-row{display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px;color:var(--gray-light)}
    .price-row.total{
      font-size:18px;font-weight:700;color:var(--gold);
      padding-top:10px;border-top:1px solid rgba(255,215,0,.3);margin-top:10px
    }

    .confirm-btn{
      width:100%;padding:18px;background:var(--gold);color:var(--bg);
      border:none;border-radius:15px;font-size:18px;font-weight:700;cursor:pointer;
      transition:all .3s;display:flex;align-items:center;justify-content:center;gap:10px
    }
    .confirm-btn:disabled{background:var(--gray);cursor:not-allowed}

    .footer-note{text-align:center;padding:10px;font-size:11px;color:var(--gray)}
    .footer-note a{color:var(--gold);text-decoration:none}

    .modal-overlay{
      display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.95);
      z-index:2000;align-items:center;justify-content:center;padding:20px
    }
    .modal-overlay.show{display:flex}
    .modal-card{
      background:var(--card);border:2px solid var(--gold);border-radius:25px;
      padding:40px 30px;width:100%;max-width:420px;text-align:center;animation:fadeIn .5s ease
    }

    .searching-animation{position:relative;width:120px;height:120px;margin:0 auto 30px}
    .searching-car{font-size:50px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:2}
    .searching-ripple{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      width:60px;height:60px;border:3px solid var(--gold);border-radius:50%;animation:ripple 1.5s infinite
    }
    .searching-ripple:nth-child(2){animation-delay:.5s}
    .searching-ripple:nth-child(3){animation-delay:1s}
    .searching-title{font-size:22px;font-weight:700;margin-bottom:10px}
    .searching-sub{color:var(--gray);font-size:14px;margin-bottom:30px}

    .cancel-search-btn{
      background:var(--card-light);border:2px solid var(--red);color:var(--red);
      padding:12px 30px;border-radius:25px;font-size:14px;font-weight:600;cursor:pointer
    }
    .cancel-search-btn:hover{background:var(--red);color:var(--white)}

    .driver-found{display:none}
    .driver-found.show{display:block;animation:fadeIn .5s ease}
    .driver-avatar{width:80px;height:80px;background:var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:40px;margin:0 auto 15px}
    .driver-name{font-size:22px;font-weight:700;margin-bottom:5px}
    .driver-rating{color:var(--gold);font-size:14px;margin-bottom:5px}
    .driver-vehicle{color:var(--gray);font-size:14px;margin-bottom:20px}
    .driver-eta{background:var(--card-light);border-radius:15px;padding:15px;margin-bottom:20px}
    .eta-label{font-size:12px;color:var(--gray);margin-bottom:5px}
    .eta-time{font-size:28px;font-weight:800;color:var(--green)}
    .driver-actions{display:flex;gap:10px;margin-bottom:10px}
    .driver-action-btn{
      flex:1;padding:15px;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:8px
    }
    .driver-action-btn.call{background:var(--green);color:var(--white);border:none}
    .driver-action-btn.cancel{background:var(--card-light);color:var(--red);border:2px solid var(--red)}
    .driver-action-btn.sos{background:var(--red);color:var(--white);border:none;animation:sosPulse 2s infinite}
    .commission-badge{
      background:rgba(0,200,83,.1);border:1px solid var(--green);
      border-radius:10px;padding:10px;margin-top:15px;font-size:12px;color:var(--green)
    }

    .tracking-panel{
      display:none;background:var(--card);border-top-left-radius:25px;border-top-right-radius:25px;
      padding:20px;box-shadow:0 -10px 40px rgba(0,0,0,.5)
    }
    .tracking-panel.show{display:block;animation:slideUp .5s ease}
    .tracking-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
    .tracking-status{display:flex;align-items:center;gap:10px}
    .tracking-status-dot{width:12px;height:12px;background:var(--green);border-radius:50%;animation:pulse 1s infinite}
    .tracking-status-text{font-size:14px;font-weight:600;color:var(--green)}
    .tracking-info{background:var(--card-light);border-radius:15px;padding:15px;margin-bottom:15px}
    .tracking-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0}
    .tracking-row:not(:last-child){border-bottom:1px solid var(--card)}
    .tracking-label{color:var(--gray);font-size:13px}
    .tracking-value{font-weight:600;font-size:14px}
    .tracking-actions{display:flex;gap:10px}

    /* Overlay lieux */
    .location-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.97);z-index:2500;
      display:none;align-items:flex-end;justify-content:center
    }
    .location-overlay.show{display:flex}
    .location-panel{
      width:100%;max-width:520px;max-height:100vh;background:#111;
      border-top-left-radius:22px;border-top-right-radius:22px;
      padding:16px 16px 24px;display:flex;flex-direction:column;animation:slideUp .3s ease
    }
    .location-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .location-title{font-size:18px;font-weight:800;color:var(--gold)}
    .location-close{background:transparent;border:none;color:#fff;font-size:22px;width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .location-zones{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px;margin-bottom:10px}
    .zone-pill{
      flex-shrink:0;border-radius:999px;padding:8px 12px;font-size:13px;border:1px solid #444;
      background:#1a1a1a;color:#fff;cursor:pointer;white-space:nowrap
    }
    .zone-pill.active{border-color:var(--gold);background:rgba(255,215,0,.15);color:var(--gold)}
    .location-list{flex:1;overflow-y:auto;margin-top:6px;border-radius:14px;background:#151515;padding:6px}
    .location-item{
      width:100%;text-align:left;background:#202020;border-radius:10px;border:1px solid #333;color:#fff;
      padding:12px 14px;font-size:15px;font-weight:600;margin-bottom:6px;cursor:pointer
    }
    .location-item:hover{border-color:var(--gold);background:#252525}
    .location-helper{font-size:12px;color:#aaa;margin-bottom:6px}

    .sos-modal{
      display:none;position:fixed;inset:0;background:rgba(255,82,82,.95);
      z-index:3000;align-items:center;justify-content:center;padding:20px
    }
    .sos-modal.show{display:flex}
    .sos-card{
      background:var(--card);border:3px solid var(--red);border-radius:25px;
      padding:30px 24px;width:100%;max-width:420px;text-align:center;animation:fadeIn .3s ease
    }
    .sos-icon{font-size:54px;margin-bottom:10px}
    .sos-title{font-size:22px;font-weight:900;color:var(--white);margin-bottom:8px}
    .sos-subtitle{color:#fff;opacity:.9;font-size:13px;margin-bottom:12px}
    .sos-location{background:rgba(0,0,0,.2);border-radius:12px;padding:12px;margin-bottom:12px;font-size:13px}
    .sos-location-label{opacity:.9;margin-bottom:6px}
    .sos-location-coords{font-family:monospace}
    .sos-actions{display:flex;flex-direction:column;gap:10px}
    .sos-call-btn{
      width:100%;padding:16px;background:#fff;color:#b91c1c;border:none;border-radius:15px;
      font-size:16px;font-weight:900;cursor:pointer
    }
    .sos-share-btn{
      width:100%;padding:14px;background:rgba(0,0,0,.25);color:#fff;border:2px solid rgba(255,255,255,.55);
      border-radius:15px;font-size:14px;font-weight:800;cursor:pointer
    }
    .sos-cancel-btn{width:100%;padding:10px;background:transparent;color:#fff;border:none;font-size:14px;cursor:pointer;opacity:.9}

    @media (max-height: 700px){
      .booking-panel{padding:15px}
      .vehicle-option{padding:10px 8px}
    }
  </style>
</head>

<body>
<div class="app">
  <header class="header">
    <div class="header-left">
      <span class="header-logo">üöó</span>
      <div>
        <div class="header-title">DIGIY DRIVER</div>
        <div class="header-sub">
          VTC S√©n√©gal ‚Ä¢
          <span class="gps-indicator inactive" id="gpsIndicator">
            <span class="gps-dot"></span>
            <span id="gpsStatus">GPS OFF</span>
          </span>
        </div>
      </div>
    </div>
    <div class="header-right">
      <button class="sos-btn" onclick="triggerSOS()" title="Urgence SOS">SOS</button>
      <button class="menu-btn" onclick="openHelp()">‚ò∞</button>
    </div>
  </header>

  <div class="map-container">
    <div id="map"></div>

    <div class="sb-status disconnected" id="sbStatus">
      <span class="status-dot"></span>
      <span id="sbStatusText">Supabase OFF</span>
    </div>

    <div class="map-buttons">
      <button class="my-location-btn" id="locationBtn" onclick="toggleGPSTracking()">üìç</button>
    </div>
  </div>

  <div class="booking-panel" id="bookingPanel">
    <div class="panel-handle"></div>

    <div class="panel-title"><span>üöï</span><span>O√π allez-vous ?</span></div>

    <div class="input-group">
      <div class="input-row">
        <div class="input-icon pickup">üìç</div>
        <input type="text" class="input-field" id="pickupInput" placeholder="Point de d√©part" readonly onclick="openLocationPicker('pickup')">
      </div>
      <div class="input-divider"></div>
      <div class="input-row">
        <div class="input-icon dropoff">üèÅ</div>
        <input type="text" class="input-field" id="dropoffInput" placeholder="Destination" readonly onclick="openLocationPicker('dropoff')">
      </div>

      <!-- T√©l√©phone client -->
      <div class="input-row" style="margin-top:8px;">
        <div class="input-icon" style="background:rgba(59,130,246,0.2);color:#3b82f6;">üìû</div>
        <input type="tel" inputmode="tel" autocomplete="tel" class="input-field" id="clientPhone" placeholder="T√©l√©phone WhatsApp du client">
      </div>
    </div>

    <div class="vehicle-options">
      <div class="vehicle-option selected" data-type="eco" data-multiplier="1" onclick="selectVehicle(this)">
        <div class="vehicle-icon">üöó</div><div class="vehicle-name">√âco</div>
        <div class="vehicle-price" id="priceEco">‚Äî</div><div class="vehicle-time">3 min</div>
      </div>
      <div class="vehicle-option" data-type="confort" data-multiplier="1.3" onclick="selectVehicle(this)">
        <div class="vehicle-icon">üöô</div><div class="vehicle-name">Confort</div>
        <div class="vehicle-price" id="priceConfort">‚Äî</div><div class="vehicle-time">5 min</div>
      </div>
      <div class="vehicle-option" data-type="premium" data-multiplier="1.8" onclick="selectVehicle(this)">
        <div class="vehicle-icon">üöò</div><div class="vehicle-name">Premium</div>
        <div class="vehicle-price" id="pricePremium">‚Äî</div><div class="vehicle-time">8 min</div>
      </div>
      <div class="vehicle-option" data-type="moto" data-multiplier="0.7" onclick="selectVehicle(this)">
        <div class="vehicle-icon">üèçÔ∏è</div><div class="vehicle-name">Moto</div>
        <div class="vehicle-price" id="priceMoto">‚Äî</div><div class="vehicle-time">2 min</div>
      </div>
    </div>

    <div class="price-summary" id="priceSummary">
      <div class="price-row"><span>Distance estim√©e</span><span id="summaryDistance">‚Äî km</span></div>
      <div class="price-row"><span>Dur√©e estim√©e</span><span id="summaryDuration">‚Äî min</span></div>
      <div class="price-row"><span>Type de v√©hicule</span><span id="summaryVehicle">√âco</span></div>
      <div class="price-row total"><span>Total √† payer</span><span id="summaryTotal">‚Äî FCFA</span></div>
    </div>

    <button class="confirm-btn" id="confirmBtn" onclick="confirmBooking()" disabled>
      <span>üöï</span><span>Commander ma course</span>
    </button>

    <div class="footer-note">
      üí∞ Paiement en cash au chauffeur ‚Ä¢ <a href="https://digiylyfe.com/page-inscription-digiy/">Devenir chauffeur</a>
    </div>
  </div>

  <div class="tracking-panel" id="trackingPanel">
    <div class="panel-handle"></div>

    <div class="tracking-header">
      <div class="tracking-status">
        <div class="tracking-status-dot"></div>
        <span class="tracking-status-text" id="rideStatus">Recherche chauffeur‚Ä¶</span>
      </div>
      <button class="sos-btn" onclick="triggerSOS()" style="width:40px;height:40px;font-size:10px;">SOS</button>
    </div>

    <div class="tracking-info">
      <div class="tracking-row"><span class="tracking-label">Chauffeur</span><span class="tracking-value" id="trackingDriverName">‚Äî</span></div>
      <div class="tracking-row"><span class="tracking-label">V√©hicule</span><span class="tracking-value" id="trackingVehicle">‚Äî</span></div>
      <div class="tracking-row"><span class="tracking-label">ETA</span><span class="tracking-value" id="trackingETA" style="color:var(--green)">‚Äî</span></div>
      <div class="tracking-row"><span class="tracking-label">Prix</span><span class="tracking-value" id="trackingPrice" style="color:var(--gold)">‚Äî</span></div>
    </div>

    <div class="tracking-actions">
      <button class="driver-action-btn call" onclick="callDriver()">üìû Appeler</button>
      <button class="driver-action-btn cancel" onclick="cancelRide()">‚úï Annuler</button>
    </div>
  </div>
</div>

<!-- overlay lieux -->
<div class="location-overlay" id="locationOverlay">
  <div class="location-panel">
    <div class="location-header">
      <div class="location-title" id="locationTitle">Choisir un lieu</div>
      <button class="location-close" onclick="closeLocationOverlay()">‚úï</button>
    </div>
    <div class="location-helper">Zone ‚Üí lieu exact. Gros texte, simple terrain üëÄ</div>
    <div class="location-zones" id="locationZones"></div>
    <div class="location-list" id="locationList"></div>
  </div>
</div>

<!-- modal recherche -->
<div class="modal-overlay" id="searchingModal">
  <div class="modal-card">

    <div id="searchingState">
      <div class="searching-animation">
        <div class="searching-ripple"></div>
        <div class="searching-ripple"></div>
        <div class="searching-ripple"></div>
        <div class="searching-car">üöó</div>
      </div>
      <div class="searching-title">Recherche d'un chauffeur‚Ä¶</div>
      <div class="searching-sub">Ta demande part dans le r√©seau DIGIY.</div>
      <button class="cancel-search-btn" onclick="cancelSearch()">‚úï Annuler</button>
    </div>

    <div class="driver-found" id="driverFoundState">
      <div class="driver-avatar">üë§</div>
      <div class="driver-name" id="foundDriverName">‚Äî</div>
      <div class="driver-rating">‚≠ê <span id="foundDriverRating">‚Äî</span> ‚Ä¢ <span id="foundDriverTrips">‚Äî</span> courses</div>
      <div class="driver-vehicle" id="foundDriverVehicle">‚Äî</div>

      <div class="driver-eta">
        <div class="eta-label">Arriv√©e dans</div>
        <div class="eta-time" id="foundDriverETA">‚Äî</div>
      </div>

      <div class="driver-actions">
        <button class="driver-action-btn call" onclick="callDriver()">üìû Appeler</button>
        <button class="driver-action-btn sos" onclick="triggerSOS()">üÜò SOS</button>
      </div>

      <button class="driver-action-btn cancel" style="margin-top:10px;" onclick="cancelRide()">‚úï Annuler</button>

      <div class="commission-badge">
        üíö 0% commission ‚Äî Le chauffeur garde 100% de vos <span id="foundPrice">‚Äî</span> FCFA
      </div>
    </div>

  </div>
</div>

<!-- SOS -->
<div class="sos-modal" id="sosModal">
  <div class="sos-card">
    <div class="sos-icon">üÜò</div>
    <div class="sos-title">ALERTE SOS</div>
    <div class="sos-subtitle">On pr√©pare un message + position √† partager.</div>

    <div class="sos-location">
      <div class="sos-location-label">üìç Position actuelle</div>
      <div class="sos-location-coords" id="sosCoords">R√©cup√©ration‚Ä¶</div>
    </div>

    <div class="sos-actions">
      <button class="sos-call-btn" onclick="callEmergency()">üìû Appeler Police (17)</button>
      <button class="sos-share-btn" onclick="shareLocation()">üì§ Partager ma position</button>
      <button class="sos-cancel-btn" onclick="closeSOS()">‚Üê Fermer</button>
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';

  /* üîê SUPABASE ‚Äî D√âJ√Ä POS√â */
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  const TABLE = "ride_requests";
  const PRICE_PER_KM = 400;         // base
  const MIN_PRICE = 1000;           // plancher
  const FLOOR_BY_TYPE = {           // plancher par v√©hicule (dignit√© chauffeur)
    eco: 2000,
    confort: 2500,
    premium: 3500,
    moto: 1500
  };

  const EMERGENCY_TEL = "tel:17";

  // Supabase client
  if(!window.supabase?.createClient){
    alert("Supabase non charg√© (CDN).");
    return;
  }
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Status badge
  const sbStatus = document.getElementById("sbStatus");
  const sbStatusText = document.getElementById("sbStatusText");
  function setSbOnline(ok){
    sbStatus.classList.toggle("connected", !!ok);
    sbStatus.classList.toggle("disconnected", !ok);
    sbStatusText.textContent = ok ? "Supabase ON" : "Supabase OFF";
  }

  // Map
  let map=null;
  let pickupMarker=null, dropoffMarker=null, routeLine=null;
  let myPosition=null, myPositionMarker=null;
  let gpsWatchId=null, isGPSTracking=false;

  // Ride realtime
  let currentRideId=null;
  let channelRide=null;

  // Booking state
  let booking={
    pickup:null,
    dropoff:null,
    pickupName:"",
    dropoffName:"",
    vehicleType:"eco",
    multiplier:1,
    distance:0,
    duration:0,
    price:0
  };

  // UI
  const gpsIndicator=document.getElementById("gpsIndicator");
  const gpsStatus=document.getElementById("gpsStatus");
  const locationBtn=document.getElementById("locationBtn");

  const pickupInput=document.getElementById("pickupInput");
  const dropoffInput=document.getElementById("dropoffInput");
  const clientPhoneEl=document.getElementById("clientPhone");
  const priceSummary=document.getElementById("priceSummary");
  const confirmBtn=document.getElementById("confirmBtn");

  const summaryDistance=document.getElementById("summaryDistance");
  const summaryDuration=document.getElementById("summaryDuration");
  const summaryVehicle=document.getElementById("summaryVehicle");
  const summaryTotal=document.getElementById("summaryTotal");

  const bookingPanel=document.getElementById("bookingPanel");
  const trackingPanel=document.getElementById("trackingPanel");
  const rideStatus=document.getElementById("rideStatus");

  const trackingDriverName=document.getElementById("trackingDriverName");
  const trackingVehicle=document.getElementById("trackingVehicle");
  const trackingETA=document.getElementById("trackingETA");
  const trackingPrice=document.getElementById("trackingPrice");

  const searchingModal=document.getElementById("searchingModal");
  const searchingState=document.getElementById("searchingState");
  const driverFoundState=document.getElementById("driverFoundState");

  const foundDriverName=document.getElementById("foundDriverName");
  const foundDriverRating=document.getElementById("foundDriverRating");
  const foundDriverTrips=document.getElementById("foundDriverTrips");
  const foundDriverVehicle=document.getElementById("foundDriverVehicle");
  const foundDriverETA=document.getElementById("foundDriverETA");
  const foundPrice=document.getElementById("foundPrice");

  // Overlay lieux (national)
  let currentLocationType="pickup";

  // ‚úÖ Lieux (tu peux encore enrichir apr√®s, ici d√©j√† national solide)
  const LOCATIONS = {
    // A√©roports
    "A√©roport International Blaise Diagne (AIBD)": {lat:14.6700,lng:-17.0733},
    "AIBD D√©parts": {lat:14.6712,lng:-17.0745},
    "AIBD Arriv√©es": {lat:14.6689,lng:-17.0723},
    "AIBD Zone H√¥tels": {lat:14.6734,lng:-17.0778},
    "A√©roport L√©opold S√©dar Senghor (LSS)": {lat:14.7397,lng:-17.4902},
    "Yoff A√©roport": {lat:14.7423,lng:-17.4867},
    "Diass": {lat:14.6234,lng:-17.0567},
    "Ndiass": {lat:14.6156,lng:-17.0489},

    // Dakar centre
    "M√©dina": {lat:14.6907,lng:-17.4559},
    "Plateau": {lat:14.6695,lng:-17.4390},
    "Port de Dakar": {lat:14.6734,lng:-17.4267},
    "Gare Ferroviaire Dakar": {lat:14.6712,lng:-17.4378},
    "Gare Routi√®re Pompiers": {lat:14.6756,lng:-17.4445},
    "Fann": {lat:14.6845,lng:-17.4656},
    "Point E": {lat:14.6923,lng:-17.4634},
    "Mermoz": {lat:14.7012,lng:-17.4712},
    "Sacr√©-C≈ìur": {lat:14.7234,lng:-17.4523},
    "Libert√© 6": {lat:14.7156,lng:-17.4612},

    // Dakar nord/ouest
    "Almadies": {lat:14.7445,lng:-17.5095},
    "Ouakam": {lat:14.7228,lng:-17.4789},
    "Yoff": {lat:14.7615,lng:-17.4685},
    "Ngor": {lat:14.7512,lng:-17.5156},
    "Mamelles": {lat:14.7289,lng:-17.4934},

    // Banlieue
    "Parcelles Assainies": {lat:14.7678,lng:-17.4234},
    "Gu√©diawaye": {lat:14.7689,lng:-17.4134},
    "Pikine": {lat:14.7645,lng:-17.3967},
    "Thiaroye": {lat:14.7534,lng:-17.3756},
    "Yeumbeul": {lat:14.7867,lng:-17.3556},
    "Keur Massar": {lat:14.7834,lng:-17.3234},
    "Rufisque": {lat:14.7167,lng:-17.2667},
    "Diamniadio": {lat:14.7234,lng:-17.1834},

    // Petite C√¥te
    "Mbour Centre": {lat:14.4167,lng:-16.9667},
    "Saly Centre": {lat:14.4500,lng:-16.9833},
    "Saly Portudal": {lat:14.4456,lng:-17.0012},
    "Ngaparou": {lat:14.4634,lng:-17.0089},
    "Somone": {lat:14.4823,lng:-17.0678},
    "Popenguine": {lat:14.5445,lng:-17.1267},
    "Warang": {lat:14.4156,lng:-16.9423},
    "Joal Centre": {lat:14.1623,lng:-16.8289},
    "Fadiouth √éle": {lat:14.1689,lng:-16.8378},

    // Thi√®s
    "Thi√®s Centre": {lat:14.7886,lng:-16.9317},
    "Thi√®s Gare": {lat:14.7956,lng:-16.9256},

    // Nord
    "Saint-Louis Centre": {lat:16.0167,lng:-16.5000},
    "Saint-Louis √éle": {lat:16.0267,lng:-16.4934},
    "Louga Centre": {lat:15.6167,lng:-16.2167},

    // Centre / Est / Sud
    "Kaolack Centre": {lat:14.1500,lng:-16.0667},
    "Diourbel Centre": {lat:14.6667,lng:-16.2333},
    "Touba Centre": {lat:14.8500,lng:-15.8833},
    "Fatick Centre": {lat:14.3333,lng:-16.4167},
    "Kaffrine Centre": {lat:14.1000,lng:-15.5500},
    "Tambacounda Centre": {lat:13.7667,lng:-13.6667},
    "Matam Centre": {lat:15.6500,lng:-13.2500},
    "Kolda Centre": {lat:12.9000,lng:-14.9500},
    "Ziguinchor Centre": {lat:12.5833,lng:-16.2667},
    "S√©dhiou Centre": {lat:12.7083,lng:-15.5569},
    "K√©dougou Centre": {lat:12.5600,lng:-12.1750}
  };

  const ZONES_CONFIG = [
    { id:'aeroports', label:'‚úàÔ∏è A√âROPORTS' },
    { id:'dakar', label:'üèôÔ∏è Dakar' },
    { id:'banlieue', label:'üèòÔ∏è Banlieue' },
    { id:'petitecote', label:'üèñÔ∏è Petite C√¥te' },
    { id:'thies', label:'üèôÔ∏è Thi√®s' },
    { id:'nord', label:'üèõÔ∏è Nord' },
    { id:'centre', label:'üåø Centre' },
    { id:'sud', label:'üå¥ Sud' },
    { id:'est', label:'‚õ∞Ô∏è Est' },
    { id:'tout', label:'üåç Tout' }
  ];

  function filterLocationsByZone(zoneId){
    const names = Object.keys(LOCATIONS);
    const has = (s, w)=> s.toLowerCase().includes(w);
    if(zoneId==='aeroports') return names.filter(n=> has(n,'aibd') || has(n,'a√©roport') || has(n,'lss') || has(n,'yoff a√©roport') || has(n,'diass'));
    if(zoneId==='dakar') return names.filter(n=> ['plateau','m√©dina','port','gare','fann','point e','mermoz','sacr√©','libert√©','almadies','ouakam','yoff','ngor','mamelles'].some(w=>has(n,w)));
    if(zoneId==='banlieue') return names.filter(n=> ['parcelles','gu√©diawaye','pikine','thiaroye','yeumbeul','keur massar','rufisque','diamniadio'].some(w=>has(n,w)));
    if(zoneId==='petitecote') return names.filter(n=> ['mbour','saly','ngaparou','somone','popenguine','warang','joal','fadiouth'].some(w=>has(n,w)));
    if(zoneId==='thies') return names.filter(n=> has(n,'thi√®s'));
    if(zoneId==='nord') return names.filter(n=> ['saint-louis','louga','matam'].some(w=>has(n,w)));
    if(zoneId==='centre') return names.filter(n=> ['kaolack','diourbel','touba','fatick','kaffrine'].some(w=>has(n,w)));
    if(zoneId==='sud') return names.filter(n=> ['ziguinchor','kolda','s√©dhiou'].some(w=>has(n,w)));
    if(zoneId==='est') return names.filter(n=> ['tambacounda','k√©dougou'].some(w=>has(n,w)));
    return names;
  }

  function buildZoneButtons(){
    const zonesContainer=document.getElementById('locationZones');
    zonesContainer.innerHTML='';
    ZONES_CONFIG.forEach((z,i)=>{
      const btn=document.createElement('button');
      btn.className='zone-pill'+(i===0?' active':'');
      btn.textContent=z.label;
      btn.dataset.zoneId=z.id;
      btn.onclick=()=>selectZone(z.id);
      zonesContainer.appendChild(btn);
    });
  }
  function renderLocationList(names){
    const list=document.getElementById('locationList');
    list.innerHTML='';
    names.forEach(name=>{
      const btn=document.createElement('button');
      btn.className='location-item';
      btn.textContent=name;
      btn.onclick=()=>chooseLocation(name);
      list.appendChild(btn);
    });
  }
  function selectZone(zoneId){
    document.querySelectorAll('.zone-pill').forEach(p=> p.classList.toggle('active', p.dataset.zoneId===zoneId));
    renderLocationList(filterLocationsByZone(zoneId));
  }
  function openLocationPicker(type){
    currentLocationType=type;
    document.getElementById('locationTitle').textContent = (type==='pickup') ? "Choisir le point de d√©part" : "Choisir la destination";
    document.getElementById('locationOverlay').classList.add('show');
    selectZone('aeroports');
  }
  function closeLocationOverlay(){
    document.getElementById('locationOverlay').classList.remove('show');
  }
  function chooseLocation(name){
    const c=LOCATIONS[name];
    if(!c) return;
    if(currentLocationType==='pickup'){
      booking.pickup={lat:c.lat,lng:c.lng};
      booking.pickupName=name;
      pickupInput.value=name;
      addPickupMarker(c.lat,c.lng);
    }else{
      booking.dropoff={lat:c.lat,lng:c.lng};
      booking.dropoffName=name;
      dropoffInput.value=name;
      addDropoffMarker(c.lat,c.lng);
    }
    closeLocationOverlay();
    checkIfReady();
  }

  function initMap(){
    const SEN=[14.4974,-14.4524];
    map = L.map('map',{center:SEN,zoom:8,zoomControl:true});
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,minZoom:6,attribution:'¬© DIGIY DRIVER'}).addTo(map);
    startGPSTracking();
  }

  function addPickupMarker(lat,lng){
    if(pickupMarker) map.removeLayer(pickupMarker);
    const icon=L.divIcon({className:'',html:`<div style="background:#00C853;width:20px;height:20px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,.3)"></div>`,iconSize:[20,20],iconAnchor:[10,10]});
    pickupMarker=L.marker([lat,lng],{icon}).addTo(map);
  }
  function addDropoffMarker(lat,lng){
    if(dropoffMarker) map.removeLayer(dropoffMarker);
    const icon=L.divIcon({className:'',html:`<div style="background:#FFD700;width:20px;height:20px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,.3)"></div>`,iconSize:[20,20],iconAnchor:[10,10]});
    dropoffMarker=L.marker([lat,lng],{icon}).addTo(map);
  }
  function drawRoute(){
    if(routeLine) map.removeLayer(routeLine);
    routeLine=L.polyline([[booking.pickup.lat,booking.pickup.lng],[booking.dropoff.lat,booking.dropoff.lng]],{color:'#FFD700',weight:4,opacity:.8,dashArray:'10,10'}).addTo(map);
    map.fitBounds(routeLine.getBounds(),{padding:[50,50]});
  }

  function toggleGPSTracking(){ isGPSTracking ? stopGPSTracking() : startGPSTracking(); }
  function startGPSTracking(){
    if(!navigator.geolocation){alert("GPS non support√©");return;}
    gpsWatchId=navigator.geolocation.watchPosition((pos)=>{
      const lat=pos.coords.latitude, lng=pos.coords.longitude, acc=pos.coords.accuracy;
      myPosition={lat,lng,accuracy:acc};
      if(myPositionMarker){ myPositionMarker.setLatLng([lat,lng]); }
      else{
        const icon=L.divIcon({className:'',html:`<div style="position:relative;width:20px;height:20px">
          <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:50px;height:50px;background:rgba(33,150,243,.2);border-radius:50%"></div>
          <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:16px;height:16px;background:#2196F3;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,.3)"></div>
        </div>`,iconSize:[20,20],iconAnchor:[10,10]});
        myPositionMarker=L.marker([lat,lng],{icon}).addTo(map);
      }
      if(!booking.pickup){
        booking.pickup={lat,lng};
        booking.pickupName="Ma position actuelle";
        pickupInput.value="Ma position actuelle";
        addPickupMarker(lat,lng);
      }
      updateGPSIndicator(true);
      locationBtn.classList.add("tracking");
    },(err)=>{
      console.log(err);
      updateGPSIndicator(false);
    },{enableHighAccuracy:true,timeout:10000,maximumAge:0});
    isGPSTracking=true;
    updateGPSIndicator(true);
    locationBtn.classList.add("tracking");
  }
  function stopGPSTracking(){
    if(gpsWatchId!==null){ navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId=null; }
    isGPSTracking=false;
    updateGPSIndicator(false);
    locationBtn.classList.remove("tracking");
  }
  function updateGPSIndicator(active){
    gpsIndicator.classList.toggle("active",!!active);
    gpsIndicator.classList.toggle("inactive",!active);
    gpsStatus.textContent = active ? "GPS ON" : "GPS OFF";
  }

  function checkIfReady(){
    if(booking.pickup && booking.dropoff){
      calculateRoutePrice();
      confirmBtn.disabled=false;
    }
  }

  function haversineKm(a,b){
    const R=6371;
    const dLat=(b.lat-a.lat)*Math.PI/180;
    const dLng=(b.lng-a.lng)*Math.PI/180;
    const x=Math.sin(dLat/2)**2 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;
    return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
  }

  function calculateRoutePrice(){
    let dist=haversineKm(booking.pickup, booking.dropoff);
    dist = dist * 1.30; // petit facteur routes
    booking.distance=dist;
    booking.duration=Math.round(dist/30*60);

    // base price arrondi 100
    let base = Math.max(MIN_PRICE, Math.round((dist*PRICE_PER_KM)/100)*100);

    // plancher par type (dignit√©)
    const floor = FLOOR_BY_TYPE[booking.vehicleType] || MIN_PRICE;
    base = Math.max(base, floor);

    booking.price = Math.round((base * booking.multiplier)/100)*100;

    // UI
    document.getElementById("priceEco").textContent = base.toLocaleString() + " F";
    document.getElementById("priceConfort").textContent = (Math.round((base*1.3)/100)*100).toLocaleString() + " F";
    document.getElementById("pricePremium").textContent = (Math.round((base*1.8)/100)*100).toLocaleString() + " F";
    document.getElementById("priceMoto").textContent = (Math.round((base*0.7)/100)*100).toLocaleString() + " F";

    summaryDistance.textContent = booking.distance.toFixed(1) + " km";
    summaryDuration.textContent = booking.duration + " min";
    summaryTotal.textContent = booking.price.toLocaleString() + " FCFA";
    summaryVehicle.textContent = document.querySelector(".vehicle-option.selected .vehicle-name").textContent;
    priceSummary.classList.add("show");

    drawRoute();
  }

  window.selectVehicle = function(el){
    document.querySelectorAll(".vehicle-option").forEach(x=>x.classList.remove("selected"));
    el.classList.add("selected");
    booking.vehicleType = el.dataset.type;
    booking.multiplier = parseFloat(el.dataset.multiplier);
    if(booking.pickup && booking.dropoff) calculateRoutePrice();
  };

  // ---- Supabase ride flow ----
  async function pingSupabase(){
    try{
      const { data, error } = await sb.from(TABLE).select("id").limit(1);
      setSbOnline(!error);
    }catch(_){
      setSbOnline(false);
    }
  }

  function showSearching(){
    searchingModal.classList.add("show");
    searchingState.style.display="block";
    driverFoundState.classList.remove("show");
    rideStatus.textContent="Recherche chauffeur‚Ä¶";
  }

  function showDriverFound(ride){
    searchingState.style.display="none";
    driverFoundState.classList.add("show");

    const name = ride.driver_name || "Chauffeur DIGIY";
    const veh = ride.driver_vehicle || "‚Äî";
    const dphone = ride.assigned_driver_phone || "‚Äî";

    foundDriverName.textContent = name;
    foundDriverRating.textContent = ride.driver_rating || "‚Äî";
    foundDriverTrips.textContent = ride.driver_trips || "‚Äî";
    foundDriverVehicle.textContent = veh + (dphone!=="‚Äî" ? (" ‚Ä¢ " + dphone) : "");
    foundDriverETA.textContent = ride.driver_eta_min ? (ride.driver_eta_min + " min") : "‚Äî";
    foundPrice.textContent = (booking.price||0).toLocaleString();

    // Tracking panel
    trackingDriverName.textContent = name;
    trackingVehicle.textContent = veh;
    trackingETA.textContent = ride.driver_eta_min ? (ride.driver_eta_min + " min") : "‚Äî";
    trackingPrice.textContent = (booking.price||0).toLocaleString() + " FCFA";

    // switch UI
    searchingModal.classList.remove("show");
    bookingPanel.style.display="none";
    trackingPanel.classList.add("show");
    rideStatus.textContent="Chauffeur trouv√© ‚úÖ";
  }

  async function createRide(){
    const clientPhone = (clientPhoneEl.value||"").trim() || null;

    // üî• colonnes compatibles avec ton sch√©ma actuel (texte + basics)
    const payload = {
      status: "new",
      city: guessCityFromNames(),
      pickup_text: booking.pickupName || "‚Äî",
      dropoff_text: booking.dropoffName || "‚Äî",
      client_phone: clientPhone,
      vehicle_type: booking.vehicleType,
      amount: booking.price || null,
      payment_method: "cash",
      pax: 1
    };

    // insert ‚Üí retourne id
    const { data, error } = await sb.from(TABLE).insert(payload).select("*").single();
    if(error) throw error;
    return data;
  }

  function guessCityFromNames(){
    const s = (booking.pickupName + " " + booking.dropoffName).toLowerCase();
    if(s.includes("saly")||s.includes("mbour")||s.includes("somone")||s.includes("ngaparou")||s.includes("joal")) return "Mbour";
    if(s.includes("thi√®s")) return "Thi√®s";
    if(s.includes("saint-louis")) return "Saint-Louis";
    if(s.includes("ziguinchor")) return "Ziguinchor";
    if(s.includes("touba")) return "Touba";
    if(s.includes("kaolack")) return "Kaolack";
    if(s.includes("aibd")||s.includes("diass")||s.includes("ndiass")) return "AIBD";
    return "Dakar";
  }

  function subscribeRide(rideId){
    // clean
    if(channelRide){ try{ sb.removeChannel(channelRide); }catch(_){ } channelRide=null; }

    channelRide = sb.channel("client_ride_" + rideId)
      .on("postgres_changes", { event:"UPDATE", schema:"public", table:TABLE, filter:`id=eq.${rideId}` }, (payload)=>{
        const ride = payload.new;
        if(!ride) return;

        if(ride.status === "accepted"){
          showDriverFound(ride);
        }
        if(ride.status === "cancelled"){
          alert("Course annul√©e.");
          resetUI();
        }
        if(ride.status === "done"){
          alert("Course termin√©e. Merci üôè");
          resetUI();
        }
        if(ride.status === "rejected"){
          alert("Course refus√©e. R√©essaie.");
          resetUI();
        }
      })
      .subscribe();
  }

  window.confirmBooking = async function(){
    try{
      showSearching();
      await pingSupabase();

      const ride = await createRide();
      currentRideId = ride.id;

      // realtime
      subscribeRide(currentRideId);

      // si un driver accepte tr√®s vite et que le realtime rate (rare),
      // on fait un mini refresh apr√®s 2s
      setTimeout(async ()=>{
        if(!currentRideId) return;
        const { data } = await sb.from(TABLE).select("*").eq("id", currentRideId).single();
        if(data && data.status === "accepted") showDriverFound(data);
      }, 2000);

    }catch(e){
      console.log(e);
      alert("Erreur cr√©ation course: " + (e?.message || e));
      searchingModal.classList.remove("show");
    }
  };

  window.cancelSearch = async function(){
    searchingModal.classList.remove("show");
    if(currentRideId){
      await sb.from(TABLE).update({ status:"cancelled", cancelled_by:"client", cancelled_at:new Date().toISOString() }).eq("id", currentRideId);
      currentRideId=null;
    }
  };

  window.cancelRide = async function(){
    if(!currentRideId){
      resetUI(); return;
    }
    if(!confirm("Annuler la course ?")) return;
    await sb.from(TABLE).update({ status:"cancelled", cancelled_by:"client", cancelled_at:new Date().toISOString() }).eq("id", currentRideId);
    currentRideId=null;
    resetUI();
  };

  function resetUI(){
    try{ if(channelRide){ sb.removeChannel(channelRide); } }catch(_){}
    channelRide=null;
    currentRideId=null;

    searchingModal.classList.remove("show");
    trackingPanel.classList.remove("show");
    bookingPanel.style.display="block";
    rideStatus.textContent="‚Äî";
  }

  // Call driver
  window.callDriver = function(){
    // on utilise ce qui est affich√© si dispo
    const txt = document.getElementById("foundDriverVehicle").textContent || "";
    const m = txt.match(/(\+?\d{9,15})/);
    if(m && m[1]) window.location.href = "tel:" + m[1];
  };

  // Menu
  window.openHelp = function(){
    alert("DIGIY DRIVER\n‚Ä¢ Choisis d√©part + destination\n‚Ä¢ Confirme\n‚Ä¢ Le chauffeur accepte dans PRO\n0% commission ‚Äî paiement direct.");
  };

  // SOS safe
  window.triggerSOS = function(){
    getCurrentPosition().then(pos=>{
      document.getElementById("sosModal").classList.add("show");
      document.getElementById("sosCoords").textContent = pos.lat.toFixed(6)+", "+pos.lng.toFixed(6);
      if(navigator.vibrate) navigator.vibrate([200,100,200]);
    }).catch(()=>{
      document.getElementById("sosModal").classList.add("show");
      document.getElementById("sosCoords").textContent="Position non disponible";
    });
  };
  function getCurrentPosition(){
    return new Promise((resolve,reject)=>{
      if(myPosition) return resolve(myPosition);
      if(!navigator.geolocation) return reject(new Error("GPS off"));
      navigator.geolocation.getCurrentPosition((p)=>resolve({lat:p.coords.latitude,lng:p.coords.longitude}),reject,{enableHighAccuracy:true,timeout:10000});
    });
  }
  window.callEmergency = function(){ window.location.href = EMERGENCY_TEL; };
  window.shareLocation = function(){
    getCurrentPosition().then(pos=>{
      const url = `https://www.google.com/maps?q=${pos.lat},${pos.lng}`;
      const text = `Ma position: ${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)}\n${url}`;
      if(navigator.share){
        navigator.share({ title:"SOS - Position", text, url });
      }else{
        navigator.clipboard.writeText(text).then(()=> alert("Position copi√©e ‚úÖ"));
      }
    });
  };
  window.closeSOS = function(){ document.getElementById("sosModal").classList.remove("show"); };

  // init
  document.addEventListener("DOMContentLoaded", async ()=>{
    initMap();
    buildZoneButtons();
    await pingSupabase();
  });

})();
</script>
</body>
</html>
